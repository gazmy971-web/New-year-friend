<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Year Raffle</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align:center; background:#f0f2f5; color: #333; padding-bottom: 50px;}
h2 { color: #2c3e50; margin-bottom: 10px; }
button { padding:12px 25px; font-size:16px; margin:10px; border:none; border-radius:50px;
background:#007bff; color:white; cursor:pointer; transition: background 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
button:hover { background:#0056b3; }
button:disabled { background: #ccc; cursor: not-allowed; }
.admin-btn { background-color: #6c757d; margin-top: 30px;}
select { padding: 10px 15px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 20px; width: 80%; max-width: 300px;}
table { margin:auto; padding:10px; border-collapse:collapse; font-size:16px; display:none; margin-top: 30px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; width: 90%; max-width: 600px; }
th, td { border:1px solid #ddd; padding:12px; text-align: left; }
th { background-color: #f8f9fa; font-weight: bold; }
#loading { color: #007bff; font-weight: bold; margin-top: 20px;}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

</head>
<body>

<h2>ğŸ„ New Year Raffle ğŸ„</h2>

<div id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...<br>(Ù„Ùˆ Ø·ÙˆÙ„Øª ÙŠØ¨Ù‚Ù‰ ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)</div>

<div id="gameArea" style="display:none;">
    <p>Ø§Ø®ØªØ§Ø± Ø§Ø³Ù…Ùƒ ÙˆØ§Ø¶ØºØ· Spin</p>
    <select id="selector"><option value="" disabled selected>-- Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ --</option></select>
    <br>
    <canvas id="wheel" width="400" height="400" style="max-width: 100%; height: auto;"></canvas>
    <br>
    <button onclick="spin()" id="spinBtn">SPIN ğŸ²</button>
    <div id="result" style="font-size:24px; font-weight:bold; margin-top:20px; color:#28a745;"></div>
</div>

<div id="lockedMessage" style="display:none; padding:20px; border:2px dashed #dc3545; margin:20px; background:white;">
    â›” Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ø§Ù„ÙØ¹Ù„! <br>
    <span id="savedChoice" style="color:#28a745; display:block; margin-top:10px; font-weight:bold;"></span>
</div>

<hr style="margin: 40px 0; border: 0; border-top: 1px solid #ddd;">
<button onclick="revealResults()" class="admin-btn">Admin Dashboard ğŸ”’</button>
<table id="resultsTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø¯ÙŠØ©</th></tr></thead><tbody></tbody></table>

<script>
    // ==========================================
    // âš ï¸âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ Firebase Ù‡Ù†Ø§ âš ï¸âš ï¸
    // ==========================================
    
    // Ø§Ù…Ø³Ø­ Ø§Ù„Ø¬Ø²Ø¡ Ø¯Ù‡ ÙˆØ­Ø· Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ù†Ø³Ø®ØªÙ‡ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Firebase Ù…ÙƒØ§Ù†Ù‡
    const firebaseConfig = {apiKey: "AIzaSyC0FUJkBWjqvDWDx3mZ1mzh9hkaipvAbR8",
  authDomain: "new-year-friend.firebaseapp.com",
  databaseURL: "https://new-year-friend-default-rtdb.firebaseio.com",
  projectId: "new-year-friend",
  storageBucket: "new-year-friend.firebasestorage.app",
  messagingSenderId: "715747500662",
  appId: "1:715747500662:web:9d6a888a32d55d10a9f557"
};
    
    // ==========================================
    // Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    // ==========================================

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ØµÙ„ÙŠØ© (ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· ÙÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    const initialNamesList = ["Edress","Jijo","Ajay","Abualsoud","Rinu","Abdelaziz","Khalid","Lija","Somi","Karthik","Cleo","Wala","Wael","Hashem","Rini","Sowmya","Margeret","Sreepa","Anju tom","Ruksana","Ambia","Jesmol","Hossam","George","Shaza","Asma","Fatima"];

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const targetsRef = db.ref('targets'); // Ø§Ù„Ù‡Ø¯Ø§ÙŠØ§ Ø§Ù„Ù…ØªØ§Ø­Ø©
    const resultsRef = db.ref('results'); // Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
    let availableTargets = [];
    let namesOnWheel = [];
    let arc = 0;
    let startAngle = 0;
    let spinning = false;

    // --- Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
    window.onload = function() {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù‡Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø¶ÙŠØ©ØŸ Ù„Ùˆ ÙØ§Ø¶ÙŠØ© Ù†Ù…Ù„Ø§Ù‡Ø§ Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
        targetsRef.once('value', (snapshot) => {
            if (!snapshot.exists()) {
                targetsRef.set(initialNamesList);
            }
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø­Ù„ÙŠ: Ù‡Ù„ Ù„Ø¹Ø¨Øª Ù…Ù† Ù‚Ø¨Ù„ØŸ
        let savedPerson = localStorage.getItem('raffle_person');
        let savedSelected = localStorage.getItem('raffle_selected');

        if (savedPerson && savedSelected) {
            showLocked(savedPerson, savedSelected);
            document.getElementById('loading').style.display = 'none';
        } else {
            initGame();
        }
    };

    function initGame() {
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
        targetsRef.on('value', (snapshot) => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            const data = snapshot.val();
            availableTargets = data ? Object.values(data) : []; 
            
            updateDropdown();
            prepareWheel(availableTargets);
        });
    }

    function updateDropdown() {
        const selector = document.getElementById("selector");
        const currentVal = selector.value;
        
        selector.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ --</option>';
        
        initialNamesList.sort().forEach(n => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = n;
            selector.appendChild(opt);
        });
        
        if(currentVal) selector.value = currentVal;
    }

    // --- Ø§Ù„Ø±Ø³Ù… Ø¹Ù„Ù‰ Canvas ---
    const wheel = document.getElementById("wheel");
    const ctx = wheel.getContext("2d");

    function drawWheel() {
        if (namesOnWheel.length === 0) return;
        arc = (2 * Math.PI) / namesOnWheel.length;
        for (let i = 0; i < namesOnWheel.length; i++) {
            let angle = startAngle + i * arc;
            ctx.beginPath();
            ctx.fillStyle = i % 2 === 0 ? "#FFD700" : "#FFC107";
            ctx.moveTo(200, 200);
            ctx.arc(200, 200, 200, angle, angle + arc);
            ctx.fill();
            ctx.save();
            ctx.fillStyle = "black";
            ctx.translate(200, 200);
            ctx.rotate(angle + arc / 2);
            ctx.textAlign = "right";
            ctx.font = "bold 14px Arial";
            ctx.fillText(namesOnWheel[i], 180, 5);
            ctx.restore();
        }
    }
    
    function prepareWheel(list) {
        namesOnWheel = [...list];
        ctx.clearRect(0,0,400,400);
        drawWheel();
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† ---
    function spin() {
        if (spinning) return;
        const selector = document.getElementById("selector");
        let person = selector.value;
        
        if (!person) { alert("Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
        
        if (availableTargets.length === 1 && availableTargets[0] === person) {
            alert("Ø­Ø¸Ùƒ Ø³ÙŠØ¡! Ù„Ù… ÙŠØªØ¨Ù‚ Ø³ÙˆØ§ÙƒØŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.");
            return;
        }

        spinning = true;
        document.getElementById("spinBtn").disabled = true;
        
        let spinAngle = Math.random() * 3000 + 3000; 
        let duration = 3000;
        let start = null;
        
        function animate(timestamp) {
            if (!start) start = timestamp;
            let progress = timestamp - start;
            startAngle += (spinAngle * (1 - progress/duration) / 100); 
            ctx.clearRect(0, 0, 400, 400);
            drawWheel();
            
            if (progress < duration) {
                requestAnimationFrame(animate);
            } else {
                tryClaimPrize(person);
            }
        }
        requestAnimationFrame(animate);
    }

    function tryClaimPrize(person) {
        let validOptions = availableTargets.filter(n => n !== person);
        
        if(validOptions.length === 0) {
            alert("Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ùƒ!");
            spinning = false;
            document.getElementById("spinBtn").disabled = false;
            return;
        }

        let randomIndex = Math.floor(Math.random() * validOptions.length);
        let selectedPrize = validOptions[randomIndex];

        targetsRef.transaction(function(currentData) {
            if (currentData) {
                let idx = currentData.indexOf(selectedPrize);
                if (idx !== -1) {
                    currentData.splice(idx, 1); 
                    return currentData;
                }
            }
            return; 
        }, function(error, committed, snapshot) {
            if (error) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
                resetSpin();
            } else if (!committed) {
                alert('Ø³Ø¨Ù‚Ùƒ Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…! Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±...');
                tryClaimPrize(person); 
            } else {
                saveWin(person, selectedPrize);
            }
        });
    }

    function resetSpin() {
        spinning = false;
        document.getElementById("spinBtn").disabled = false;
    }

    function saveWin(person, selected) {
        resultsRef.push({
            selector: person,
            selected: selected,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        localStorage.setItem('raffle_person', person);
        localStorage.setItem('raffle_selected', selected);

        document.getElementById("result").innerText = "ğŸ‰ " + selected + " ğŸ‰";
        
        setTimeout(() => {
            alert("Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ø®ØªØ±Øª: " + selected);
            showLocked(person, selected);
        }, 1000);
    }

    function showLocked(person, selected) {
        document.getElementById('gameArea').style.display = 'none';
        document.getElementById('lockedMessage').style.display = 'block';
        document.getElementById('savedChoice').innerText = person + " -> " + selected;
    }

    // --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
    function revealResults() {
        const table = document.getElementById('resultsTable');
        if (table.style.display === 'table') {
            table.style.display = 'none';
            return;
        }

        let password = prompt("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø£Ø¯Ù…Ù†:");
        if (password === "9090") {
            table.style.display = 'table';
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = "<tr><td colspan='2'>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>";

            resultsRef.once('value', (snapshot) => {
                tbody.innerHTML = "";
                const data = snapshot.val();
                if(data) {
                    Object.values(data).forEach(record => {
                        let row = tbody.insertRow();
                        row.insertCell(0).innerText = record.selector;
                        row.insertCell(1).innerText = record.selected;
                    });
                } else {
                    tbody.innerHTML = "<tr><td colspan='2'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>";
                }
            });
        }
    }
</script>

</body>
</html>
